<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex, nofollow" />
<title>Not found · go.dip.sh</title>
<style>
  :root { --fg:#0f172a; --muted:#64748b; --link:#2563eb; --bg:#fff; --border:#e5e7eb; }
  @media (prefers-color-scheme: dark) {
    :root { --fg:#e5e7eb; --muted:#94a3b8; --link:#93c5fd; --bg:#0b1020; --border:#1f2937; }
  }
  html,body{height:100%}
  body{margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); background:var(--bg);}
  .wrap{max-width:860px; margin:clamp(24px,6vh,64px) auto; padding:0 16px;}
  h1{font-size:clamp(22px,3.5vw,32px); margin:.2rem 0 1rem;}
  p{color:var(--muted); margin:.3rem 0 .8rem;}
  .box{border:1px solid var(--border); border-radius:14px; padding:16px 16px;}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  code, .slug{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}
  input[type="search"]{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--fg);
    outline:none;
  }
  ul{list-style:none; margin:0; padding:0}
  li{padding:10px 0; border-bottom:1px dashed var(--border)}
  .hint{font-size:13px; color:var(--muted)}
  .pill{display:inline-block; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted)}
</style>

<div class="wrap">
  <h1>We couldn’t find that shortlink.</h1>
  <div class="box">
    <div class="row" id="summary">
      <div>Path:</div>
      <div class="slug" id="path">/</div>
      <span class="pill" id="kind"></span>
    </div>
    <p id="reason" class="hint">Trying a fallback lookup…</p>
    <div id="actions" class="row" style="margin-top:8px; display:none">
      <a id="openLink" href="#">Open destination</a>
      <span>·</span>
      <a id="qrLink" href="#" download>Download QR</a>
    </div>
  </div>

  <h2 style="margin-top:2rem">Maybe you meant…</h2>
  <input id="filter" type="search" placeholder="Filter available slugs (press / to focus)" aria-label="Filter slugs" />
  <ul id="suggestions" class="box" style="margin-top:12px"></ul>

  <p class="hint" style="margin-top:10px">
    Tip: Shortlinks look like <code>https://go.dip.sh/&lt;slug&gt;</code>. QR codes live at <code>https://go.dip.sh/&lt;slug&gt;.png</code>.
  </p>
</div>

<script>
(async () => {
  const byId = (x) => document.getElementById(x);
  const pathEl = byId('path');
  const kindEl = byId('kind');
  const reasonEl = byId('reason');
  const actionsEl = byId('actions');
  const openLinkEl = byId('openLink');
  const qrLinkEl = byId('qrLink');
  const filterEl = byId('filter');
  const listEl = byId('suggestions');

  // Extract slug info
  const rawPath = location.pathname.replace(/^\/+|\/+$/g, ''); // remove leading/trailing slashes
  const isPng = /\.png$/i.test(rawPath);
  const firstSeg = rawPath.split('/')[0];
  const slug = (isPng ? firstSeg.replace(/\.png$/i, '') : firstSeg) || '';
  const queryAndHash = location.search + location.hash;

  pathEl.textContent = '/' + (rawPath || '');
  kindEl.textContent = isPng ? 'QR request (.png)' : 'Shortlink path';

  // Fetch map.json (no cache: we want freshest)
  let map = {};
  try {
    const res = await fetch('/map.json', { cache: 'no-store' });
    if (res.ok) map = await res.json();
  } catch (e) {}

  const keys = Object.keys(map || {});
  const lcKeys = new Map(keys.map(k => [k.toLowerCase(), k]));

  // Exact or case-insensitive match?
  let matchKey = map[slug] ? slug : (lcKeys.get(slug.toLowerCase()) || null);

  if (matchKey) {
    const dest = map[matchKey];
    if (!isPng) {
      // Redirect to destination, preserving query/hash.
      reasonEl.textContent = 'Found a matching shortlink. Redirecting…';
      // Use replace to avoid history pollution
      location.replace(dest + queryAndHash);
      return;
    } else {
      // They asked for a QR PNG that doesn't exist. Offer links instead.
      reasonEl.textContent = 'The QR image for this slug was not found.';
      actionsEl.style.display = 'flex';
      openLinkEl.href = '/' + matchKey;
      openLinkEl.textContent = `Open /${matchKey}`;
      qrLinkEl.href = '/' + matchKey + '.png';
      qrLinkEl.textContent = `Try /${matchKey}.png`;
    }
  } else {
    reasonEl.textContent = 'No exact match found. Here are some close ones:';
  }

  // Fuzzy suggest top 10 by edit distance + prefix score
  function levenshtein(a, b) {
    a = a.toLowerCase(); b = b.toLowerCase();
    const m = a.length, n = b.length;
    if (m === 0) return n; if (n === 0) return m;
    const dp = new Uint16Array((n + 1) * (m + 1));
    for (let i = 0; i <= m; i++) dp[i*(n+1)] = i;
    for (let j = 0; j <= n; j++) dp[j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        const cost = a[i-1] === b[j-1] ? 0 : 1;
        const del = dp[(i-1)*(n+1) + j] + 1;
        const ins = dp[i*(n+1) + (j-1)] + 1;
        const sub = dp[(i-1)*(n+1) + (j-1)] + cost;
        dp[i*(n+1) + j] = Math.min(del, ins, sub);
      }
    }
    return dp[m*(n+1) + n];
  }
  function score(candidate, target) {
    const ldist = levenshtein(candidate, target);
    const prefix = target.toLowerCase().startsWith(candidate.toLowerCase()) ? -2 : 0;
    return ldist + prefix; // lower is better
  }
  function renderList(items) {
    listEl.innerHTML = items.map(k => {
      const short = '/' + k;
      const qr = '/' + k + '.png';
      const dest = map[k];
      return `<li>
        <div class="row">
          <div><a class="slug" href="${short}">${short}</a></div>
          <div class="hint">→ <a href="${dest}">${dest}</a></div>
        </div>
        <div class="hint"><a href="${qr}" download>QR</a></div>
      </li>`;
    }).join('') || '<li class="hint">No suggestions.</li>';
  }

  const sorted = keys
    .slice()
    .sort((a, b) => score(slug || '', a) - score(slug || '', b))
    .slice(0, 10);
  renderList(sorted);

  // Live filter (press / to focus)
  window.addEventListener('keydown', (e) => {
    if (e.key === '/') { e.preventDefault(); filterEl.focus(); }
  });
  filterEl.addEventListener('input', () => {
    const q = filterEl.value.trim().toLowerCase();
    if (!q) return renderList(sorted);
    const results = keys
      .filter(k => k.toLowerCase().includes(q))
      .slice(0, 20);
    renderList(results);
  });
})();
</script>
